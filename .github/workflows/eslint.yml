name: ESLint & CodeQL Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '39 11 * * 6'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  lint-and-scan:
    name: Run ESLint and Upload SARIF
    runs-on: ubuntu-latest

    steps:
      # 1. Check out your repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Install pnpm via the official setup action
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      # 3. Install Node 20 (required for CodeQL v3) and cache pnpm deps
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      # 4. Install project dependencies and add ESLint + SARIF formatter
      - name: Install dependencies
        run: |
          pnpm install
          pnpm add -D eslint@8.10.0 \
                    @microsoft/eslint-formatter-sarif@3.1.0

      # 5. Run ESLint, emit SARIF
      - name: Run ESLint â†’ SARIF
        run: |
          npx eslint . \
            --ext .js,.jsx,.ts,.tsx \
            --format @microsoft/eslint-formatter-sarif \
            --output-file eslint-results.sarif \
            || echo "ESLint completed with reports"

      # 6. Debug: list files so we can confirm SARIF location
      - name: Debug workspace layout
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          ls -R .

      # 7. Upload SARIF to GitHub Code Scanning (uses v3)
      - name: Upload SARIF to CodeQL
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: '**/*.sarif'
          wait-for-processing: true
