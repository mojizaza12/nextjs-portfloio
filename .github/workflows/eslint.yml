name: ESLint & CodeQL Scan

on:
  push:          { branches: [ "main" ] }
  pull_request:  { branches: [ "main" ] }
  schedule:
    - cron: '39 11 * * 6'

permissions:
  contents:       read
  actions:        read
  security-events: write

jobs:
  lint-and-upload:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup pnpm & Node
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      # 3. Install deps + SARIF formatter
      - name: Install dependencies
        run: |
          pnpm install
          pnpm add -D eslint@8.10.0 \
                    @microsoft/eslint-formatter-sarif@3.1.0

      # 4. Run ESLint → SARIF at repo root
      - name: Run ESLint → SARIF
        run: |
          npx eslint . \
            --ext .js,.jsx,.ts,.tsx \
            --format @microsoft/eslint-formatter-sarif \
            --output-file $GITHUB_WORKSPACE/eslint-results.sarif \
            || echo "ESLint finished"

      # 5. Debug: confirm file present
      - name: Debug SARIF files
        run: |
          echo "Workspace: $GITHUB_WORKSPACE"
          ls -R .

      # 6. Upload SARIF (v3)
      - name: Upload SARIF to CodeQL
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: '**/*.sarif'
          wait-for-processing: true
